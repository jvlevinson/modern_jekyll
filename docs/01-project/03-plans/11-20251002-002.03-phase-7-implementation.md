# Phase 7: Theme Editor - Detailed Implementation Plan
**Document ID**: 11-20251002-002.03
**Created**: October 2, 2025
**Phase Duration**: 3 weeks (40 hours)
**Priority**: üü¢ High - Modern architecture implementation
**Dependencies**:
- Phase 6 complete (Read-only dashboard)
- Research complete (10-20251002-002.02)
**Parent Plan**: 01-20251001-001.00-architectural-improvements.md

---

## ‚ö†Ô∏è DOCUMENT STATUS: HISTORICAL - PARTIAL

**This document is INCOMPLETE**:
- ‚úÖ **Week 1** (Foundation & Core Utilities) - Fully detailed and implemented
- ‚ùå **Week 2-3** - Never written (doc says "continuing in next document...")
- ‚úÖ **Implementation** - Completed via different approach based on user feedback

**For the complete implementation story, see**:
- `14-20251002-002.06-phase-7-completion.md` - Official completion summary
- `NEXT-STEPS.md` - Current status and next steps

**What happened**:
1. Week 1 tasks from this doc were completed as planned
2. Weeks 2-3 were never detailed in planning
3. Implementation continued based on user requests:
   - 2D color wheel (not in original plan)
   - Hex input/output (not in original plan)
   - All 5 neutral palettes (user feedback)
   - Secondary color toggle (user feedback)
4. Testing plan (doc 12) was deferred
5. Integration plan (doc 13) was deferred

**Phase 7 Status**: ‚úÖ **COMPLETE** (see doc 14)

---

## Overview

This document provides **step-by-step implementation tasks** for building the modern Theme Editor using TypeScript, OKLCH color space, and functional architecture. Every file, function, and test is detailed.

---

## Week 1: Foundation & Core Utilities

### Day 1: Setup & Configuration (4 hours)

#### Task 1.1: TypeScript & Build Tool Setup (1.5 hours)

**File**: `package.json`
```json
{
  "name": "modern-jekyll-dashboard",
  "version": "2.0.0",
  "private": true,
  "type": "module",
  "scripts": {
    "build": "esbuild onboard/src/main.ts --bundle --minify --outfile=onboard/assets/dist/editor.bundle.js --target=es2022 --format=esm",
    "dev": "esbuild onboard/src/main.ts --bundle --watch --sourcemap --outfile=onboard/assets/dist/editor.bundle.js --target=es2022 --format=esm",
    "type-check": "tsc --noEmit",
    "test": "echo 'Tests coming in Week 3' && exit 0"
  },
  "dependencies": {
    "culori": "^4.0.1"
  },
  "devDependencies": {
    "esbuild": "^0.24.0",
    "typescript": "^5.7.2"
  }
}
```

**File**: `tsconfig.json`
```json
{
  "compilerOptions": {
    "target": "ES2022",
    "module": "ESNext",
    "moduleResolution": "bundler",
    "lib": ["ES2022", "DOM", "DOM.Iterable"],
    "strict": true,
    "esModuleInterop": true,
    "allowSyntheticDefaultImports": true,
    "verbatimModuleSyntax": true,
    "skipLibCheck": true,
    "forceConsistentCasingInFileNames": true,
    "resolveJsonModule": true,
    "declaration": true,
    "declarationMap": true,
    "sourceMap": true,
    "outDir": "./dist",
    "rootDir": "./onboard/src",
    "types": [],
    "noUnusedLocals": true,
    "noUnusedParameters": true,
    "noImplicitReturns": true,
    "noFallthroughCasesInSwitch": true,
    "strictNullChecks": true
  },
  "include": ["onboard/src/**/*"],
  "exclude": ["node_modules", "dist", "_site"]
}
```

**Steps**:
1. Create `package.json` with dependencies
2. Create `tsconfig.json` with strict settings
3. Run `npm install` to install esbuild and TypeScript
4. Test compilation: `npm run type-check`
5. Verify build script: `npm run build` (will fail - no source files yet)

**Deliverable**: TypeScript project configured, ready for development

---

#### Task 1.2: Directory Structure (0.5 hours)

**Create directories**:
```bash
mkdir -p onboard/src/{types,utils,modules,components}
mkdir -p onboard/assets/dist
mkdir -p onboard/src/__tests__
```

**Structure**:
```
onboard/
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ types/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ color.types.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ config.types.ts
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ events.types.ts
‚îÇ   ‚îú‚îÄ‚îÄ utils/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ color-convert.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ palette-generator.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ contrast-checker.ts
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ color-presets.ts
‚îÇ   ‚îú‚îÄ‚îÄ modules/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ config-manager.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ color-picker.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ theme-editor.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ preview-manager.ts
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ event-bus.ts
‚îÇ   ‚îú‚îÄ‚îÄ components/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ (future: Web Components if needed)
‚îÇ   ‚îú‚îÄ‚îÄ __tests__/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ (Week 3)
‚îÇ   ‚îî‚îÄ‚îÄ main.ts
‚îú‚îÄ‚îÄ assets/
‚îÇ   ‚îú‚îÄ‚îÄ dist/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ editor.bundle.js (generated)
‚îÇ   ‚îú‚îÄ‚îÄ dashboard.css (existing)
‚îÇ   ‚îú‚îÄ‚îÄ dashboard.js (existing)
‚îÇ   ‚îî‚îÄ‚îÄ editor.css (new - Week 2)
‚îî‚îÄ‚îÄ index.html (existing - will modify)
```

**Deliverable**: Clean directory structure following modern conventions

---

#### Task 1.3: Type Definitions (2 hours)

**File**: `onboard/src/types/color.types.ts` (Complete)
```typescript
/**
 * =============================================================================
 * Color Type Definitions
 * =============================================================================
 * Modern color system using OKLCH color space
 * Based on research: oklch.org best practices
 * =============================================================================
 */

/**
 * OKLCH color space (perceptually uniform)
 *
 * @property l - Lightness (0-100%)
 * @property c - Chroma/saturation (0-0.4, limit to prevent over-saturation)
 * @property h - Hue (0-360 degrees)
 *
 * @example
 * const blue: OklchColor = { l: 60, c: 0.18, h: 262 };
 */
export interface OklchColor {
  l: number;  // 0-100
  c: number;  // 0-0.4
  h: number;  // 0-360
}

/**
 * HSV color space (color wheel input)
 * Used for conversion from visual color pickers
 */
export interface HsvColor {
  h: number;  // 0-360
  s: number;  // 0-100
  v: number;  // 0-100
}

/**
 * RGB color space (web standard)
 * Used for conversion from hex colors
 */
export interface RgbColor {
  r: number;  // 0-255
  g: number;  // 0-255
  b: number;  // 0-255
}

/**
 * Hex color string
 * Must match pattern: #RRGGBB
 *
 * @example "#3b82f6"
 */
export type HexColor = `#${string}`;

/**
 * Complete color palette (10 shades)
 * Generated from single base OKLCH color
 *
 * Shade progression:
 * - 50:  Lightest (95% lightness)
 * - 100-400: Light shades
 * - 500: Base color
 * - 600-900: Dark shades
 * - 900: Darkest (20% lightness)
 */
export interface ColorPalette {
  50: string;   // oklch(95% ...)
  100: string;  // oklch(90% ...)
  200: string;  // oklch(80% ...)
  300: string;  // oklch(70% ...)
  400: string;  // oklch(65% ...)
  500: string;  // Base color
  600: string;  // oklch(base.l - 10% ...)
  700: string;  // oklch(base.l - 20% ...)
  800: string;  // oklch(base.l - 30% ...)
  900: string;  // oklch(base.l - 40% ...)
}

/**
 * Palette shade type (50-900)
 */
export type PaletteShade = keyof ColorPalette;

/**
 * Color validation result
 */
export interface ColorValidation {
  valid: boolean;
  errors: string[];
}

/**
 * Contrast validation result
 * Based on WCAG 2.1 standards
 */
export interface ContrastResult {
  ratio: number;
  wcagAA: boolean;    // ‚â• 4.5:1 for normal text
  wcagAAA: boolean;   // ‚â• 7:1 for normal text
  wcagAALarge: boolean;  // ‚â• 3:1 for large text
}
```

**File**: `onboard/src/types/config.types.ts` (Complete)
```typescript
/**
 * =============================================================================
 * Configuration Type Definitions
 * =============================================================================
 * Type-safe Jekyll _config.yml structure
 * =============================================================================
 */

import { OklchColor } from './color.types';

/**
 * Theme configuration (stored in _config.yml)
 * Now stores OKLCH values instead of color names
 */
export interface ThemeConfig {
  brand_primary: OklchColor;
  brand_secondary: OklchColor | null;
  neutral: 'slate' | 'gray';
  mode: 'light' | 'dark' | 'auto';
}

/**
 * Complete site configuration
 */
export interface SiteConfig {
  theme: ThemeConfig;
  site: {
    title: string;
    author: string;
    email: string;
    description: string;
  };
}

/**
 * API response for config endpoint
 */
export interface ConfigResponse {
  success: boolean;
  theme: ThemeConfig;
  message?: string;
}

/**
 * API request for updating config
 */
export interface ConfigUpdateRequest {
  theme: Partial<ThemeConfig>;
}

/**
 * Build status
 */
export type BuildState = 'idle' | 'running' | 'complete' | 'failed';

/**
 * Build status response
 */
export interface BuildStatus {
  id: string;
  state: BuildState;
  started_at: string;
  completed_at?: string;
  output?: string[];
  error?: string;
}

/**
 * Rebuild trigger response
 */
export interface RebuildResponse {
  buildId: string;
  message: string;
}
```

**File**: `onboard/src/types/events.types.ts` (Complete)
```typescript
/**
 * =============================================================================
 * Event Type Definitions
 * =============================================================================
 * Type-safe event payloads for EventBus
 * =============================================================================
 */

import { OklchColor, ColorPalette } from './color.types';
import { ThemeConfig, BuildStatus } from './config.types';

/**
 * Event names (type-safe)
 */
export enum EventName {
  // Config events
  CONFIG_LOADED = 'config:loaded',
  CONFIG_CHANGE = 'config:change',
  CONFIG_DIRTY = 'config:dirty',
  CONFIG_SAVING = 'config:saving',
  CONFIG_SAVED = 'config:saved',
  CONFIG_RESET = 'config:reset',
  CONFIG_ERROR = 'config:error',

  // Color picker events
  COLOR_CHANGE = 'color:change',
  PALETTE_GENERATED = 'palette:generated',

  // Preview events
  PREVIEW_UPDATE = 'preview:update',
  PREVIEW_RELOAD = 'preview:reload',

  // Rebuild events
  REBUILD_STARTED = 'rebuild:started',
  REBUILD_STATUS = 'rebuild:status',
  REBUILD_COMPLETE = 'rebuild:complete',
  REBUILD_ERROR = 'rebuild:error',
}

/**
 * Event payloads
 */

export interface ConfigLoadedPayload {
  theme: ThemeConfig;
}

export interface ConfigChangePayload {
  key: keyof ThemeConfig;
  value: any;
  previousValue: any;
  theme: ThemeConfig;
}

export interface ConfigDirtyPayload {
  isDirty: boolean;
}

export interface ConfigSavedPayload {
  theme: ThemeConfig;
  message: string;
}

export interface ConfigResetPayload {
  theme: ThemeConfig;
}

export interface ConfigErrorPayload {
  error: Error;
  operation: 'load' | 'save' | 'reset';
}

export interface ColorChangePayload {
  color: OklchColor;
  previousColor: OklchColor;
  key: 'brand_primary' | 'brand_secondary';
}

export interface PaletteGeneratedPayload {
  palette: ColorPalette;
  baseColor: OklchColor;
}

export interface PreviewUpdatePayload {
  theme: Partial<ThemeConfig>;
}

export interface RebuildStatusPayload {
  status: BuildStatus;
}

/**
 * Event handler type
 */
export type EventHandler<T = any> = (payload: T) => void;

/**
 * Event map (maps event names to payload types)
 */
export interface EventMap {
  [EventName.CONFIG_LOADED]: ConfigLoadedPayload;
  [EventName.CONFIG_CHANGE]: ConfigChangePayload;
  [EventName.CONFIG_DIRTY]: ConfigDirtyPayload;
  [EventName.CONFIG_SAVING]: void;
  [EventName.CONFIG_SAVED]: ConfigSavedPayload;
  [EventName.CONFIG_RESET]: ConfigResetPayload;
  [EventName.CONFIG_ERROR]: ConfigErrorPayload;
  [EventName.COLOR_CHANGE]: ColorChangePayload;
  [EventName.PALETTE_GENERATED]: PaletteGeneratedPayload;
  [EventName.PREVIEW_UPDATE]: PreviewUpdatePayload;
  [EventName.REBUILD_STARTED]: void;
  [EventName.REBUILD_STATUS]: RebuildStatusPayload;
  [EventName.REBUILD_COMPLETE]: BuildStatus;
  [EventName.REBUILD_ERROR]: Error;
}
```

**Steps**:
1. Create all three type files
2. Run `npm run type-check` to verify
3. Fix any TypeScript errors
4. Document each interface with JSDoc comments

**Deliverable**: Complete, type-safe definitions for all data structures

---

### Day 2: Color Utilities (4 hours)

#### Task 1.4: Color Conversion Utilities (2 hours)

**File**: `onboard/src/utils/color-convert.ts` (Complete)
```typescript
/**
 * =============================================================================
 * Color Conversion Utilities
 * =============================================================================
 * Convert between color spaces: HEX ‚Üî RGB ‚Üî OKLCH
 * Uses Culori library for accurate color space conversions
 * =============================================================================
 */

import { converter, formatHex, formatRgb } from 'culori';
import type { HexColor, RgbColor, OklchColor, HsvColor } from '../types/color.types';

// Culori converters (accurate, maintained library)
const toOklch = converter('oklch');
const toRgb = converter('rgb');

/**
 * Convert HEX to RGB
 *
 * @param hex - Hex color string (e.g., "#3b82f6")
 * @returns RGB color object
 *
 * @example
 * hexToRgb("#3b82f6") // { r: 59, g: 130, b: 246 }
 */
export function hexToRgb(hex: HexColor): RgbColor {
  const rgb = toRgb(hex);
  if (!rgb) throw new Error(`Invalid hex color: ${hex}`);

  return {
    r: Math.round(rgb.r * 255),
    g: Math.round(rgb.g * 255),
    b: Math.round(rgb.b * 255)
  };
}

/**
 * Convert RGB to HEX
 *
 * @param rgb - RGB color object
 * @returns Hex color string
 *
 * @example
 * rgbToHex({ r: 59, g: 130, b: 246 }) // "#3b82f6"
 */
export function rgbToHex(rgb: RgbColor): HexColor {
  return formatHex({
    mode: 'rgb',
    r: rgb.r / 255,
    g: rgb.g / 255,
    b: rgb.b / 255
  }) as HexColor;
}

/**
 * Convert RGB to OKLCH (using Culori for accuracy)
 *
 * @param rgb - RGB color object
 * @returns OKLCH color object
 *
 * @example
 * rgbToOklch({ r: 59, g: 130, b: 246 }) // { l: 59.9, c: 0.181, h: 262.3 }
 */
export function rgbToOklch(rgb: RgbColor): OklchColor {
  const oklch = toOklch({
    mode: 'rgb',
    r: rgb.r / 255,
    g: rgb.g / 255,
    b: rgb.b / 255
  });

  if (!oklch) throw new Error(`Conversion failed for RGB: ${JSON.stringify(rgb)}`);

  return {
    l: Math.round(oklch.l * 1000) / 10, // Convert to 0-100 scale
    c: Math.round(oklch.c * 1000) / 1000,
    h: oklch.h ? Math.round(oklch.h * 10) / 10 : 0
  };
}

/**
 * Convert HEX to OKLCH
 *
 * @param hex - Hex color string
 * @returns OKLCH color object
 */
export function hexToOklch(hex: HexColor): OklchColor {
  const oklch = toOklch(hex);
  if (!oklch) throw new Error(`Invalid hex color: ${hex}`);

  return {
    l: Math.round(oklch.l * 1000) / 10,
    c: Math.round(oklch.c * 1000) / 1000,
    h: oklch.h ? Math.round(oklch.h * 10) / 10 : 0
  };
}

/**
 * Convert OKLCH to CSS string
 *
 * @param color - OKLCH color object
 * @returns CSS oklch() string
 *
 * @example
 * oklchToCss({ l: 60, c: 0.18, h: 262 }) // "oklch(60% 0.18 262deg)"
 */
export function oklchToCss(color: OklchColor): string {
  return `oklch(${color.l}% ${color.c} ${color.h}deg)`;
}

/**
 * Parse CSS oklch() string to OKLCH object
 *
 * @param css - CSS oklch() string
 * @returns OKLCH color object or null if invalid
 *
 * @example
 * parseOklchCss("oklch(60% 0.18 262deg)") // { l: 60, c: 0.18, h: 262 }
 */
export function parseOklchCss(css: string): OklchColor | null {
  const match = css.match(/oklch\((\d+\.?\d*)%?\s+(\d+\.?\d*)\s+(\d+\.?\d*)deg?\)/);

  if (!match) return null;

  return {
    l: parseFloat(match[1]),
    c: parseFloat(match[2]),
    h: parseFloat(match[3])
  };
}

/**
 * Validate OKLCH color values
 *
 * @param color - OKLCH color object
 * @returns true if valid
 */
export function validateOklch(color: OklchColor): boolean {
  return (
    color.l >= 0 && color.l <= 100 &&
    color.c >= 0 && color.c <= 0.4 &&  // Limit chroma
    color.h >= 0 && color.h < 360
  );
}

/**
 * Clamp OKLCH values to valid ranges
 *
 * @param color - OKLCH color object
 * @returns Clamped OKLCH color
 */
export function clampOklch(color: OklchColor): OklchColor {
  return {
    l: Math.max(0, Math.min(100, color.l)),
    c: Math.max(0, Math.min(0.4, color.c)),
    h: ((color.h % 360) + 360) % 360  // Wrap to 0-360
  };
}

/**
 * Check if browser supports OKLCH color space
 *
 * @returns true if OKLCH is supported
 */
export function supportsOklch(): boolean {
  if (typeof CSS === 'undefined' || !CSS.supports) return false;
  return CSS.supports('color', 'oklch(50% 0.2 180deg)');
}

/**
 * Get CSS color string with automatic fallback
 * Uses OKLCH if supported, RGB as fallback
 *
 * @param color - OKLCH color object
 * @returns CSS color string (OKLCH or RGB)
 */
export function toCssColor(color: OklchColor): string {
  if (supportsOklch()) {
    return oklchToCss(color);
  }

  // Fallback to RGB for ~7% of browsers
  const rgb = toRgb({ mode: 'oklch', l: color.l / 100, c: color.c, h: color.h });
  if (!rgb) return 'rgb(0, 0, 0)'; // Ultimate fallback

  return `rgb(${Math.round(rgb.r * 255)}, ${Math.round(rgb.g * 255)}, ${Math.round(rgb.b * 255)})`;
}
```

**Steps**:
1. Implement hex ‚Üî RGB conversion (straightforward)
2. Implement RGB ‚Üí OKLCH conversion (complex, use research formulas)
3. Implement OKLCH ‚Üí CSS string
4. Add validation and clamping
5. Test with known color values

**Deliverable**: Working color conversion utilities

---

#### Task 1.5: Palette Generator (1.5 hours)

**File**: `onboard/src/utils/palette-generator.ts` (Complete - see next section)

**Implementation details in next comment due to length...**

---

### Day 3-5: Remaining Week 1 tasks...

*[Continuing in next planning document due to length]*

---

## Task Summary (Week 1)

### Deliverables
- [ ] TypeScript + esbuild configured
- [ ] All type definitions complete
- [ ] Color conversion utilities complete
- [ ] Palette generator complete
- [ ] Contrast checker complete
- [ ] Color presets complete

### Estimated Hours: 16/40

---

**Document Status**: üîÑ In Progress - Week 1 detailed
**Next Section**: Week 2 & 3 Implementation Tasks
**Related Documents**:
- Research: 10-20251002-002.02-phase-7-modern-approach.md
- Testing Plan: (Coming next)
