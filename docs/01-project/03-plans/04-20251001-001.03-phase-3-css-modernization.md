# Phase 3: CSS Modernization - Implementation Plan
**Document ID**: 04-20251001-001.03
**Created**: October 1, 2025
**Phase Duration**: Week 2-3 (4-6 hours)
**Priority**: 🟡 High - Future-proof architecture
**Dependencies**: Phase 2 complete (token system)
**Parent Plan**: 01-20251001-001.00-architectural-improvements.md

---

## Overview

Migrate from SCSS color functions to modern CSS `color-mix()`, enabling runtime color manipulation and eliminating the need for SCSS variable fallbacks.

---

## Phase Goals

- ✅ Replace SCSS `color.adjust()` with CSS `color-mix()`
- ✅ Remove SCSS color function dependencies
- ✅ Add fallbacks for older browsers
- ✅ Maintain visual consistency

---

## Browser Support Analysis

### color-mix() Support (October 2025)

| Browser         | Version | Release    | Support |
|-----------------|---------|------------|---------|
| Chrome          | 111+    | Mar 2023   | ✅      |
| Firefox         | 113+    | May 2023   | ✅      |
| Safari          | 16.2+   | Dec 2022   | ✅      |
| Edge            | 111+    | Mar 2023   | ✅      |
| Mobile Safari   | 16.2+   | Dec 2022   | ✅      |
| Chrome Android  | 111+    | Mar 2023   | ✅      |

**Coverage**: ~95% global browser support (as of Oct 2025)
**Safe to use**: ✅ With fallbacks for older browsers

---

## Task Breakdown

### Task 3.1: Update Design Tokens with color-mix()
**Priority**: High
**Duration**: 2 hours
**Goal**: Generate hover/active variants using color-mix()

#### Files to Modify
1. `_includes/design-tokens.html`

#### Implementation Steps

**Step 1**: Update primary color hover states
```liquid
<!-- _includes/design-tokens.html -->

{% if site.theme.mode == "light" or site.theme.mode == "auto" %}
:root {
  /* Brand Colors - Primary */
  --color-primary: var(--color-primary-500);

  /* Hover states using color-mix() */
  --color-primary-hover: color-mix(in srgb, var(--color-primary) 90%, black 10%);
  --color-primary-active: color-mix(in srgb, var(--color-primary) 85%, black 15%);

  /* Lighter variant for backgrounds */
  --color-primary-light-bg: color-mix(in srgb, var(--color-primary) 10%, white 90%);

  /* Darker variant for text */
  --color-primary-dark: color-mix(in srgb, var(--color-primary) 80%, black 20%);

  {% if site.theme.brand_secondary %}
  /* Brand Colors - Secondary */
  --color-secondary: var(--color-secondary-500);
  --color-secondary-hover: color-mix(in srgb, var(--color-secondary) 90%, black 10%);
  --color-secondary-active: color-mix(in srgb, var(--color-secondary) 85%, black 15%);
  --color-secondary-light-bg: color-mix(in srgb, var(--color-secondary) 10%, white 90%);
  {% endif %}

  /* Background Colors with subtle tints */
  --color-background: #ffffff;
  --color-surface: #ffffff;
  --color-surface-hover: color-mix(in srgb, var(--color-primary) 3%, white 97%);

  /* Border Colors with opacity */
  --color-border-hover: color-mix(in srgb, var(--color-primary) 30%, var(--color-border) 70%);
}
{% endif %}
```

**Step 2**: Update dark mode hover states
```liquid
<!-- _includes/design-tokens.html -->

{% if site.theme.mode == "dark" %}
:root {
  /* Brand Colors - Primary (lighter shades for dark bg) */
  --color-primary: var(--color-primary-400);

  /* Hover states - mix toward white instead of black */
  --color-primary-hover: color-mix(in srgb, var(--color-primary) 85%, white 15%);
  --color-primary-active: color-mix(in srgb, var(--color-primary) 80%, white 20%);

  /* Light variant for hover backgrounds */
  --color-primary-light-bg: color-mix(in srgb, var(--color-primary) 15%, transparent 85%);

  {% if site.theme.brand_secondary %}
  /* Brand Colors - Secondary */
  --color-secondary: var(--color-secondary-400);
  --color-secondary-hover: color-mix(in srgb, var(--color-secondary) 85%, white 15%);
  --color-secondary-active: color-mix(in srgb, var(--color-secondary) 80%, white 20%);
  {% endif %}

  /* Surface hover with subtle highlight */
  --color-surface-hover: color-mix(in srgb, var(--color-primary) 5%, var(--color-surface) 95%);

  /* Border hover */
  --color-border-hover: color-mix(in srgb, var(--color-primary) 50%, var(--color-border) 50%);
}
{% endif %}
```

**Step 3**: Add [data-theme="dark"] variants (for JS toggle)
```liquid
<!-- _includes/design-tokens.html -->

[data-theme="dark"] {
  /* Brand Colors - Primary */
  --color-primary: var(--color-primary-400);
  --color-primary-hover: color-mix(in srgb, var(--color-primary) 85%, white 15%);
  --color-primary-active: color-mix(in srgb, var(--color-primary) 80%, white 20%);
  --color-primary-light-bg: color-mix(in srgb, var(--color-primary) 15%, transparent 85%);

  {% if site.theme.brand_secondary %}
  --color-secondary: var(--color-secondary-400);
  --color-secondary-hover: color-mix(in srgb, var(--color-secondary) 85%, white 15%);
  --color-secondary-active: color-mix(in srgb, var(--color-secondary) 80%, white 20%);
  {% endif %}

  --color-surface-hover: color-mix(in srgb, var(--color-primary) 5%, var(--color-surface) 95%);
  --color-border-hover: color-mix(in srgb, var(--color-primary) 50%, var(--color-border) 50%);
}
```

**Step 4**: Add auto mode with prefers-color-scheme
```liquid
<!-- _includes/design-tokens.html -->

{% if site.theme.mode == "auto" %}
@media (prefers-color-scheme: dark) {
  :root {
    /* Same dark mode color-mix() rules */
    --color-primary: var(--color-primary-400);
    --color-primary-hover: color-mix(in srgb, var(--color-primary) 85%, white 15%);
    /* ... etc */
  }
}
{% endif %}
```

#### Testing Checklist
- [ ] Light mode hover colors correct
- [ ] Dark mode hover colors correct
- [ ] Auto mode switches correctly
- [ ] JS toggle works with color-mix()
- [ ] All palette choices work (orange, blue, green, purple, red)

---

### Task 3.2: Update Button Component
**Priority**: High
**Duration**: 1 hour
**Goal**: Replace SCSS color functions in buttons

#### Files to Modify
1. `_sass/components/_buttons.scss`
2. `_sass/abstracts/_mixins.scss`

#### Implementation Steps

**Step 1**: Update button-variant mixin
```scss
// _sass/abstracts/_mixins.scss

@mixin button-variant($color, $background, $border) {
  color: $color;
  background-color: $background;
  border-color: $border;
  @include transition-all;

  &:hover,
  &:focus,
  &.focus,
  &:active,
  &.active {
    color: $color;
    // BEFORE: background-color: color.adjust($background, $lightness: -5%);
    // AFTER: Use CSS custom property or color-mix
    background-color: color-mix(in srgb, $background 90%, black 10%);
    border-color: color-mix(in srgb, $border 85%, black 15%);
  }

  // Disabled states unchanged
  &.disabled,
  &[disabled],
  &:disabled,
  fieldset[disabled] & {
    &,
    &:hover,
    &:focus,
    &.focus,
    &:active,
    &.active {
      background-color: $background;
      border-color: $border;
      opacity: var(--opacity-65);
      cursor: not-allowed;
    }
  }

  .badge {
    color: $background;
    background-color: $color;
  }
}
```

**Step 2**: Update button components to use tokens directly
```scss
// _sass/components/_buttons.scss

.btn-primary {
  background-color: var(--color-primary);
  color: var(--color-text-inverse);
  border: 2px solid var(--color-primary);

  &:hover,
  &:focus {
    // Use pre-defined token instead of mixin calculation
    background-color: var(--color-primary-hover);
    border-color: var(--color-primary-hover);
    color: var(--color-text-inverse);

    // Add subtle shadow for depth
    box-shadow: var(--shadow-md);
  }

  &:active,
  &.active {
    background-color: var(--color-primary-active);
    border-color: var(--color-primary-active);
    color: var(--color-text-inverse);
    box-shadow: var(--shadow-sm);
  }
}

.btn-default,
.btn-outline-secondary {
  background-color: transparent;
  color: var(--color-text);
  border: 2px solid var(--color-text-inverse);

  &:hover,
  &:focus {
    background-color: var(--color-text-inverse);
    border-color: var(--color-text-inverse);
    color: var(--color-primary);
  }

  &:active,
  &.active {
    background-color: var(--color-text-inverse);
    border-color: var(--color-text-inverse);
    color: var(--color-primary-active);
  }
}
```

**Step 3**: Remove SCSS color module imports (if no longer needed)
```scss
// _sass/abstracts/_mixins.scss

// BEFORE:
@use 'sass:color';

// AFTER (check if still needed elsewhere):
// Remove if color.adjust() no longer used
```

#### Testing Checklist
- [ ] Primary button hover works
- [ ] Outline button hover works
- [ ] All color palettes work
- [ ] Light/dark mode correct
- [ ] Disabled states visible
- [ ] Active states work

---

### Task 3.3: Add Browser Fallbacks
**Priority**: Medium
**Duration**: 1 hour
**Goal**: Support older browsers gracefully

#### Implementation Strategy

**Step 1**: Add @supports detection
```scss
// _sass/components/_buttons.scss

.btn-primary {
  background-color: var(--color-primary);

  &:hover,
  &:focus {
    // Fallback for browsers without color-mix()
    background-color: var(--color-primary-600);

    // Modern browsers with color-mix() support
    @supports (background-color: color-mix(in srgb, red, blue)) {
      background-color: var(--color-primary-hover);
    }
  }
}
```

**Step 2**: Ensure fallback tokens exist
```liquid
<!-- _includes/design-tokens.html -->

:root {
  /* Primary palette - always available for fallbacks */
  --color-primary-400: {{ primary_palette[400] }};
  --color-primary-500: {{ primary_palette[500] }};
  --color-primary-600: {{ primary_palette[600] }};
  --color-primary-700: {{ primary_palette[700] }};

  /* Semantic tokens */
  --color-primary: var(--color-primary-500);

  /* Modern color-mix() (with fallback above) */
  --color-primary-hover: var(--color-primary-600);  /* Fallback */

  @supports (color: color-mix(in srgb, red, blue)) {
    --color-primary-hover: color-mix(in srgb, var(--color-primary) 90%, black 10%);
  }
}
```

**Step 3**: Alternative approach - Define both
```liquid
<!-- _includes/design-tokens.html -->

:root {
  /* Fallback tokens (static shades from palette) */
  --color-primary-hover-fallback: var(--color-primary-600);
  --color-primary-active-fallback: var(--color-primary-700);

  /* Modern tokens (color-mix) */
  --color-primary-hover: var(--color-primary-hover-fallback);
  --color-primary-active: var(--color-primary-active-fallback);
}

@supports (color: color-mix(in srgb, red, blue)) {
  :root {
    --color-primary-hover: color-mix(in srgb, var(--color-primary) 90%, black 10%);
    --color-primary-active: color-mix(in srgb, var(--color-primary) 85%, black 15%);
  }
}
```

#### Testing Checklist
- [ ] Test in latest Chrome (color-mix works)
- [ ] Test in latest Firefox (color-mix works)
- [ ] Test in latest Safari (color-mix works)
- [ ] Simulate older browser (fallback works)
- [ ] Visual consistency maintained

---

### Task 3.4: Update Portfolio Overlay
**Priority**: Medium
**Duration**: 0.5 hours
**Goal**: Modernize portfolio overlay colors

#### Files to Modify
1. `_sass/components/_portfolio-box.scss`
2. `_sass/components/_portfolio-flip.scss`

#### Implementation Steps

**Step 1**: Update portfolio overlay
```scss
// _sass/components/_portfolio-box.scss

.portfolio-box-caption {
  // BEFORE:
  // background: color-mix(in srgb, var(--color-primary) 90%, transparent);

  // AFTER (more precise control):
  background: color-mix(in srgb, var(--color-primary) 90%, black 10%);
  backdrop-filter: blur(4px);  // Modern glass effect

  &:hover {
    background: color-mix(in srgb, var(--color-primary) 95%, black 5%);
  }
}
```

**Step 2**: Update flip back side
```scss
// _sass/components/_portfolio-flip.scss

.portfolio-flip-back {
  background: var(--color-primary);

  // Add gradient for depth
  background: linear-gradient(
    135deg,
    var(--color-primary) 0%,
    color-mix(in srgb, var(--color-primary) 90%, black 10%) 100%
  );
}
```

#### Testing Checklist
- [ ] Portfolio overlay visible
- [ ] Flip back readable
- [ ] Gradient smooth
- [ ] Backdrop blur works (modern browsers)

---

### Task 3.5: Remove SCSS Color Dependencies
**Priority**: Low
**Duration**: 0.5 hours
**Goal**: Clean up unused SCSS imports

#### Files to Check
1. `_sass/abstracts/_mixins.scss`
2. `_sass/abstracts/_variables.scss`
3. All component SCSS files

#### Implementation Steps

**Step 1**: Search for SCSS color module usage
```bash
# Find all @use 'sass:color' imports
grep -r "@use 'sass:color'" _sass/

# Find all color.adjust() usage
grep -r "color\.adjust\|color\.scale\|color\.mix" _sass/
```

**Step 2**: Remove if no longer used
```scss
// _sass/abstracts/_mixins.scss

// BEFORE:
@use 'sass:color';

// AFTER:
// Remove line if color.adjust() no longer used
```

**Step 3**: Update _variables.scss
```scss
// _sass/abstracts/_variables.scss

// Remove SCSS fallback variables if no longer needed:
// BEFORE:
$theme-primary: #f97316;
$theme-dark: #0f172a;
$color-primary: #f97316;
$color-dark: #0f172a;
$color-light: #fff;

// AFTER (only keep if still used in SCSS functions):
// Check if any SCSS code still references these
```

**Step 4**: Verify build still works
```bash
bundle exec jekyll build

# Should complete without errors
# Check for any SCSS compilation warnings
```

#### Testing Checklist
- [ ] Build completes successfully
- [ ] No SCSS warnings
- [ ] Visual appearance unchanged
- [ ] All color-mix() working

---

## Phase 3 Testing Strategy

### Visual Regression Testing
```bash
# Take screenshots before migration
npm run screenshot:baseline

# Implement changes

# Take screenshots after migration
npm run screenshot:test

# Compare (should be identical)
npm run screenshot:compare
```

### Browser Testing Matrix

| Browser          | Version  | color-mix() | Fallback | Pass |
|------------------|----------|-------------|----------|------|
| Chrome           | Latest   | ✅          | N/A      | [ ]  |
| Firefox          | Latest   | ✅          | N/A      | [ ]  |
| Safari           | Latest   | ✅          | N/A      | [ ]  |
| Edge             | Latest   | ✅          | N/A      | [ ]  |
| Chrome           | 110      | ❌          | ✅       | [ ]  |
| Safari           | 16.1     | ❌          | ✅       | [ ]  |

### Performance Testing
```bash
# Before migration
npm run build:prod
# Check CSS file size

# After migration
npm run build:prod
# Check CSS file size (should be smaller - no redundant SCSS)
```

---

## Success Metrics

- [ ] All `color.adjust()` replaced with `color-mix()`
- [ ] Fallbacks work in older browsers
- [ ] CSS file size maintained or reduced
- [ ] Build time unchanged or faster
- [ ] Visual appearance identical
- [ ] No SCSS warnings/errors

---

## Deliverables

### Code
- [ ] Updated `_includes/design-tokens.html`
- [ ] Updated `_sass/components/_buttons.scss`
- [ ] Updated `_sass/abstracts/_mixins.scss`
- [ ] Updated `_sass/components/_portfolio-box.scss`
- [ ] Updated `_sass/components/_portfolio-flip.scss`
- [ ] Removed unused SCSS color imports

### Documentation
- [ ] Document browser support requirements
- [ ] Document fallback strategy
- [ ] Update CLAUDE.md with browser requirements

---

## Rollback Plan

### If color-mix() Issues Occur
```scss
// Quick revert to SCSS color functions
@use 'sass:color';

.btn-primary:hover {
  background-color: color.adjust(var(--color-primary), $lightness: -5%);
}
```

### Known Risks
- **Browser Support**: Minimal risk (95% coverage)
- **Visual Differences**: May need opacity adjustments
- **Performance**: color-mix() is runtime, may be slightly slower (negligible)

---

## Sign-Off

### Completed Tasks
- [ ] Task 3.1: Update design tokens
- [ ] Task 3.2: Update button component
- [ ] Task 3.3: Add browser fallbacks
- [ ] Task 3.4: Update portfolio overlay
- [ ] Task 3.5: Remove SCSS dependencies

### Phase 3 Complete
- [ ] All color-mix() implemented
- [ ] Fallbacks tested
- [ ] Build successful
- [ ] Ready for Phase 4

**Completed By**: _____________
**Date**: _____________

---

**Document Status**: ✅ Ready for Implementation
**Last Updated**: October 1, 2025
**Next Phase**: 05-20251001-001.04-phase-4-bem-migration.md
