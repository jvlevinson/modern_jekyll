# Phase 7: Theme Editor - Integration & Deployment Plan
**Document ID**: 13-20251002-002.05
**Created**: October 2, 2025
**Deployment Date**: TBD (Post-implementation & testing)
**Priority**: ðŸ”´ Critical - Production deployment
**Dependencies**: Implementation + Testing complete
**Type**: Integration, deployment, and rollback strategy

---

## Overview

This document outlines the systematic integration of the TypeScript-based Theme Editor into the existing Onboard Dashboard, deployment procedures, and rollback strategies.

---

## Integration Strategy

### Approach: Parallel Implementation

**Why**: Minimize risk by building new system alongside existing dashboard

```
Phase 1: Build (Week 1-2)
â””â”€ Develop TypeScript modules independently

Phase 2: Test (Week 3)
â””â”€ Validate in isolation

Phase 3: Integrate (Week 4)
â””â”€ Wire into existing dashboard

Phase 4: Deploy
â””â”€ Cut over to new system
```

---

## Integration Steps

### Step 1: Prepare Existing Dashboard (Pre-Integration)

#### 1.1: Update HTML Structure

**File**: `onboard/index.html`

**Current Theme Section** (Read-only):
```html
<section id="section-theme" class="dashboard__section">
  <h2>Theme Configuration</h2>

  <div class="config-group">
    <label>Primary Brand Color</label>
    <div class="color-display" id="current-primary">
      <span class="color-swatch"></span>
      <span class="color-label">Blue</span>
    </div>
  </div>

  <div class="config-group">
    <label>Secondary Brand Color</label>
    <div class="color-display" id="current-secondary">
      <span class="color-swatch"></span>
      <span class="color-label">Green</span>
    </div>
  </div>

  <!-- More read-only displays... -->
</section>
```

**New Theme Section** (Editable):
```html
<section id="section-theme" class="dashboard__section">
  <h2>Theme Configuration</h2>

  <!-- Mode: Read-Only vs Edit -->
  <div class="dashboard__mode-toggle">
    <button class="btn btn--sm" id="toggle-edit-mode">
      <i class="fa-solid fa-edit"></i> Edit Theme
    </button>
  </div>

  <!-- Read-Only View (default) -->
  <div id="theme-view-mode" class="theme-mode theme-mode--active">
    <div class="config-group">
      <label>Primary Brand Color</label>
      <div class="color-display" id="current-primary">
        <span class="color-swatch"></span>
        <span class="color-label">Blue</span>
      </div>
    </div>

    <div class="config-group">
      <label>Secondary Brand Color</label>
      <div class="color-display" id="current-secondary">
        <span class="color-swatch"></span>
        <span class="color-label">Green</span>
      </div>
    </div>

    <!-- Palette preview -->
    <div class="palette-preview" id="palette-display"></div>
  </div>

  <!-- Edit Mode (TypeScript editor) -->
  <div id="theme-edit-mode" class="theme-mode" hidden>
    <!-- Primary Color Picker -->
    <div id="primary-color-picker"></div>

    <!-- Secondary Color Picker -->
    <div id="secondary-color-picker"></div>

    <!-- Mode Toggle (light/dark/auto) -->
    <div class="config-group">
      <label>Theme Mode</label>
      <div class="theme-mode-toggle">
        <button class="theme-mode-toggle__btn" data-mode="light">Light</button>
        <button class="theme-mode-toggle__btn" data-mode="dark">Dark</button>
        <button class="theme-mode-toggle__btn" data-mode="auto">Auto</button>
      </div>
    </div>

    <!-- Save/Cancel Actions -->
    <div class="dashboard__actions">
      <button class="btn btn--primary" id="save-theme" disabled>
        Save Changes
      </button>
      <button class="btn btn--outline" id="reset-theme">
        Reset
      </button>
      <button class="btn btn--outline" id="cancel-edit">
        Cancel
      </button>
    </div>

    <!-- Rebuild Status -->
    <div id="rebuild-status" class="rebuild-status" hidden>
      <div class="rebuild-status__spinner"></div>
      <p class="rebuild-status__message">Building site...</p>
    </div>
  </div>
</section>
```

**Changes**:
1. Add mode toggle button
2. Wrap read-only view in `#theme-view-mode`
3. Add edit mode container `#theme-edit-mode`
4. Add placeholders for TypeScript components
5. Add save/cancel/reset buttons

---

#### 1.2: Load TypeScript Bundle

**File**: `onboard/index.html` (bottom of `<body>`)

**Add before existing `dashboard.js`**:
```html
<!-- TypeScript Editor Bundle (ES Module) -->
<script type="module" src="assets/dist/editor.bundle.js"></script>

<!-- Existing dashboard script -->
<script src="assets/dashboard.js"></script>
```

**Why "before"**: TypeScript module needs to load first to register components

---

#### 1.3: Update CSS

**File**: `onboard/assets/dashboard.css`

**Add at bottom**:
```css
/* =============================================================================
   Theme Editor Styles
   ============================================================================= */

/* Mode toggle */
.dashboard__mode-toggle {
  margin-bottom: var(--space-md);
}

.theme-mode {
  display: none;
}

.theme-mode--active {
  display: block;
}

/* Actions */
.dashboard__actions {
  display: flex;
  gap: var(--space-sm);
  margin-top: var(--space-lg);
}

.dashboard__actions .btn {
  flex: 1;
}

/* Rebuild status */
.rebuild-status {
  margin-top: var(--space-md);
  padding: var(--space-md);
  background: var(--color-surface-alt);
  border-radius: var(--radius-md);
  border-left: 4px solid var(--color-primary);
}

.rebuild-status__spinner {
  width: 20px;
  height: 20px;
  border: 3px solid var(--color-border);
  border-top-color: var(--color-primary);
  border-radius: 50%;
  animation: spin 0.6s linear infinite;
  display: inline-block;
  margin-right: var(--space-sm);
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

.rebuild-status__message {
  display: inline;
  margin: 0;
}
```

---

### Step 2: Initialize TypeScript Editor

#### 2.1: Entry Point

**File**: `onboard/src/main.ts`

```typescript
/**
 * =============================================================================
 * Onboard Theme Editor - Main Entry Point
 * =============================================================================
 * Initializes the TypeScript-based theme editor
 * =============================================================================
 */

import { createThemeEditor } from './modules/theme-editor';
import { EventBus, EventName } from './modules/event-bus';

/**
 * Initialize dashboard editor on DOM ready
 */
function init() {
  console.log('[Editor] Initializing TypeScript theme editor...');

  // Security check: localhost only
  if (!isLocalhost()) {
    console.warn('[Editor] Not on localhost - editor disabled');
    return;
  }

  // Wait for DOM
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initEditor);
  } else {
    initEditor();
  }
}

/**
 * Initialize editor after DOM ready
 */
function initEditor() {
  try {
    // Create theme editor
    const editor = createThemeEditor({
      primaryPickerId: 'primary-color-picker',
      secondaryPickerId: 'secondary-color-picker',
      previewIframeId: 'site-preview'
    });

    // Setup mode toggle
    setupModeToggle(editor);

    // Listen for errors
    EventBus.on(EventName.CONFIG_ERROR, (payload) => {
      console.error('[Editor] Config error:', payload.error);
      showError(payload.error.message);
    });

    console.log('[Editor] Theme editor initialized successfully');

  } catch (error) {
    console.error('[Editor] Initialization failed:', error);
    showError('Failed to initialize theme editor');
  }
}

/**
 * Setup view/edit mode toggle
 */
function setupModeToggle(editor: any) {
  const toggleBtn = document.getElementById('toggle-edit-mode');
  const viewMode = document.getElementById('theme-view-mode');
  const editMode = document.getElementById('theme-edit-mode');
  const cancelBtn = document.getElementById('cancel-edit');

  toggleBtn?.addEventListener('click', () => {
    viewMode?.setAttribute('hidden', '');
    viewMode?.classList.remove('theme-mode--active');

    editMode?.removeAttribute('hidden');
    editMode?.classList.add('theme-mode--active');

    // Initialize editor components
    editor.render();

    toggleBtn.textContent = 'View Mode';
  });

  cancelBtn?.addEventListener('click', () => {
    editMode?.setAttribute('hidden', '');
    editMode?.classList.remove('theme-mode--active');

    viewMode?.removeAttribute('hidden');
    viewMode?.classList.add('theme-mode--active');

    toggleBtn.textContent = 'Edit Theme';

    // Reset any pending changes
    editor.reset();
  });
}

/**
 * Check if running on localhost
 */
function isLocalhost(): boolean {
  const hostname = window.location.hostname;
  return ['localhost', '127.0.0.1', '0.0.0.0', ''].includes(hostname);
}

/**
 * Show error message
 */
function showError(message: string) {
  // Could use a toast notification library
  alert(`Error: ${message}`);
}

// Start initialization
init();
```

---

### Step 3: Build & Deploy

#### 3.1: Development Build

```bash
# 1. Install dependencies
npm install

# 2. Type check
npm run type-check

# 3. Build for development (with sourcemaps)
npm run dev
```

**Output**: `onboard/assets/dist/editor.bundle.js` + `.map`

---

#### 3.2: Production Build

```bash
# 1. Run tests
npm test

# 2. Type check
npm run type-check

# 3. Build for production (minified, no sourcemaps)
npm run build

# 4. Verify bundle size
ls -lh onboard/assets/dist/editor.bundle.js
# Target: < 150KB (gzipped < 50KB)
```

---

#### 3.3: Jekyll Build Integration

**File**: `_config.yml`

**Add TypeScript build to Jekyll workflow**:

```yaml
# Build configuration
exclude:
  - _tests_/
  - node_modules/
  - onboard/src/        # Exclude TypeScript source
  - package.json
  - package-lock.json
  - tsconfig.json

# Include compiled JS
include:
  - onboard/assets/dist/
```

**Jekyll build command**:
```bash
# Full build (TypeScript + Jekyll)
npm run build && bundle exec jekyll build
```

---

### Step 4: Verification

#### 4.1: Smoke Test Checklist

**After integration, verify**:

- [ ] Dashboard loads without errors
- [ ] "Edit Theme" button visible
- [ ] Clicking "Edit Theme" shows color pickers
- [ ] Color pickers render correctly
- [ ] Presets display
- [ ] Selecting color generates palette
- [ ] Save button enables when color changes
- [ ] Cancel button resets changes
- [ ] Console has no TypeScript errors

#### 4.2: Integration Test

```typescript
// Manual test script
// Open browser console on http://localhost:4000/onboard/

// 1. Check if editor loaded
console.log('Editor loaded:', typeof window.onboardEditor !== 'undefined');

// 2. Test color selection
document.querySelector('#toggle-edit-mode').click();
document.querySelector('input[type="color"]').value = '#ef4444';
document.querySelector('input[type="color"]').dispatchEvent(new Event('input'));

// 3. Check palette generated
console.log('Palette:', document.querySelectorAll('.color-picker__shade').length);
// Expected: 10 shades

// 4. Check save button enabled
console.log('Save enabled:', !document.querySelector('#save-theme').disabled);
// Expected: true
```

---

## Deployment Strategy

### Deployment Environments

```
1. Development (localhost)
   â””â”€ npm run dev (watch mode)

2. Staging (if applicable)
   â””â”€ npm run build
   â””â”€ bundle exec jekyll serve

3. Production (GitHub Pages / Netlify)
   â””â”€ npm run build
   â””â”€ bundle exec jekyll build
   â””â”€ Deploy _site/
```

---

### Deployment Checklist

#### Pre-Deployment

- [ ] All tests passing (unit + integration + E2E)
- [ ] TypeScript compiles with no errors
- [ ] Build succeeds (npm run build)
- [ ] Bundle size within limits (< 150KB)
- [ ] Manual smoke test passed
- [ ] Accessibility audit passed (axe)
- [ ] Browser compatibility tested
- [ ] Documentation updated

#### Deployment Steps

1. **Build Assets**
   ```bash
   npm run build
   ```

2. **Verify Output**
   ```bash
   ls -lh onboard/assets/dist/
   # Should see: editor.bundle.js
   ```

3. **Build Jekyll Site**
   ```bash
   bundle exec jekyll build
   ```

4. **Test Production Build**
   ```bash
   bundle exec jekyll serve --skip-initial-build
   # Open http://localhost:4000/onboard/
   # Verify editor works
   ```

5. **Deploy**
   - **GitHub Pages**: `git push origin main`
   - **Netlify**: Auto-deploy on push
   - **Manual**: Upload `_site/` to server

#### Post-Deployment

- [ ] Verify editor loads on production URL
- [ ] Test critical user flow (select color â†’ save)
- [ ] Monitor for errors (browser console)
- [ ] Check Lighthouse score (should be â‰¥ 95)

---

## Rollback Strategy

### Scenario 1: Critical Bug in Production

**If editor breaks production**:

1. **Immediate**: Disable edit mode
   ```html
   <!-- onboard/index.html -->
   <button id="toggle-edit-mode" disabled>
     Edit Theme (Temporarily Disabled)
   </button>
   ```

2. **Remove TypeScript bundle**
   ```html
   <!-- Comment out -->
   <!-- <script type="module" src="assets/dist/editor.bundle.js"></script> -->
   ```

3. **Rebuild and redeploy**
   ```bash
   bundle exec jekyll build
   # Deploy
   ```

**Result**: Dashboard returns to read-only mode (Phase 6 state)

---

### Scenario 2: Performance Regression

**If editor slows down dashboard**:

1. **Lazy load editor**
   ```javascript
   // Only load when "Edit Theme" clicked
   document.getElementById('toggle-edit-mode').addEventListener('click', async () => {
     const { createThemeEditor } = await import('./assets/dist/editor.bundle.js');
     // Initialize editor
   });
   ```

2. **Code split**
   ```bash
   # Split into smaller chunks
   esbuild --splitting --format=esm ...
   ```

---

### Scenario 3: Browser Compatibility Issue

**If OKLCH not supported**:

1. **Feature detection**
   ```typescript
   if (!CSS.supports('color', 'oklch(50% 0.2 180deg)')) {
     console.warn('OKLCH not supported - falling back to RGB');
     showWarning('Your browser does not support advanced color features');
     // Disable edit mode or fallback to RGB
   }
   ```

2. **Fallback UI**
   ```html
   <div class="browser-warning">
     Your browser does not support advanced color editing.
     Please use Chrome 111+, Safari 15.4+, or Firefox 113+.
   </div>
   ```

---

## Migration Path

### From Hard-Coded Palettes to OKLCH

**Challenge**: Existing `_config.yml` uses color names:
```yaml
theme:
  brand_primary: "blue"     # Old format
  brand_secondary: "green"
```

**New format requires OKLCH**:
```yaml
theme:
  brand_primary:
    l: 60
    c: 0.18
    h: 262
  brand_secondary:
    l: 60
    c: 0.18
    h: 145
```

### Migration Script

**File**: `_tests_/migrate-config.rb`

```ruby
#!/usr/bin/env ruby

require 'yaml'

# Color name to OKLCH mapping (from old color-palettes.yml)
COLOR_MAP = {
  'orange' => { 'l' => 70, 'c' => 0.18, 'h' => 60 },
  'blue'   => { 'l' => 60, 'c' => 0.18, 'h' => 262 },
  'green'  => { 'l' => 60, 'c' => 0.18, 'h' => 145 },
  'purple' => { 'l' => 60, 'c' => 0.21, 'h' => 310 },
  'red'    => { 'l' => 55, 'c' => 0.22, 'h' => 25 }
}

# Load config
config = YAML.load_file('_config.yml')

# Migrate theme section
if config['theme']['brand_primary'].is_a?(String)
  primary_name = config['theme']['brand_primary']
  config['theme']['brand_primary'] = COLOR_MAP[primary_name]

  puts "Migrated brand_primary: #{primary_name} â†’ #{COLOR_MAP[primary_name]}"
end

if config['theme']['brand_secondary'].is_a?(String)
  secondary_name = config['theme']['brand_secondary']
  config['theme']['brand_secondary'] = COLOR_MAP[secondary_name]

  puts "Migrated brand_secondary: #{secondary_name} â†’ #{COLOR_MAP[secondary_name]}"
end

# Backup original
File.write('_config.yml.backup', File.read('_config.yml'))

# Write migrated config
File.write('_config.yml', config.to_yaml)

puts "\nâœ… Migration complete!"
puts "   Backup saved to: _config.yml.backup"
```

**Run migration**:
```bash
chmod +x _tests_/migrate-config.rb
./_tests_/migrate-config.rb
```

**Verify**:
```bash
cat _config.yml | grep -A 5 "theme:"
```

---

## Monitoring & Maintenance

### Post-Deployment Monitoring

**Week 1**: Daily checks
- [ ] Dashboard accessible
- [ ] No JavaScript errors in console
- [ ] Editor functions correctly
- [ ] Save/rebuild works

**Week 2-4**: Weekly checks
- [ ] Performance metrics stable
- [ ] No user-reported issues
- [ ] Lighthouse score maintained

**Monthly**: Full audit
- [ ] Accessibility re-check
- [ ] Browser compatibility
- [ ] Dependency updates

### Maintenance Tasks

**Quarterly**:
- [ ] Update dependencies (`npm update`)
- [ ] Re-run full test suite
- [ ] Lighthouse performance audit
- [ ] Review and address technical debt

**Annually**:
- [ ] Review OKLCH browser support (should increase)
- [ ] Consider new CSS color features
- [ ] Evaluate TypeScript version upgrade

---

## Success Metrics

### Technical Metrics

- [ ] **Build time**: < 1 second
- [ ] **Bundle size**: < 150KB (< 50KB gzipped)
- [ ] **Load time**: < 500ms (editor.bundle.js)
- [ ] **Lighthouse**: â‰¥ 95/100 (all categories)

### User Experience Metrics

- [ ] **Edit mode activation**: < 200ms
- [ ] **Color selection â†’ palette**: < 100ms
- [ ] **Save â†’ rebuild complete**: < 5s
- [ ] **Zero errors**: No console errors

### Quality Metrics

- [ ] **Test coverage**: â‰¥ 90%
- [ ] **Type safety**: 100% (strict mode)
- [ ] **Accessibility**: WCAG 2.1 AA
- [ ] **Browser support**: Chrome 111+, Safari 15.4+, Firefox 113+

---

## Troubleshooting Guide

### Issue: Editor not loading

**Symptoms**: Edit mode button does nothing

**Diagnosis**:
1. Check browser console for errors
2. Verify `editor.bundle.js` loaded
3. Check network tab for 404s

**Solution**:
```bash
# Rebuild TypeScript
npm run build

# Verify output exists
ls onboard/assets/dist/editor.bundle.js

# Rebuild Jekyll
bundle exec jekyll build
```

---

### Issue: Color picker not rendering

**Symptoms**: Blank edit mode section

**Diagnosis**:
1. Check if TypeScript initialized
2. Verify container IDs match
3. Check for JavaScript errors

**Solution**:
- Verify HTML has `id="primary-color-picker"`
- Check `main.ts` uses correct IDs
- Inspect element to see if components mounted

---

### Issue: OKLCH colors not displaying

**Symptoms**: Colors appear black or unsupported

**Diagnosis**:
```javascript
// In browser console
CSS.supports('color', 'oklch(50% 0.2 180deg)')
// Should return true
```

**Solution**:
- Update browser to latest version
- Show fallback message for old browsers
- Consider RGB fallback (future enhancement)

---

**Document Status**: âœ… Complete
**Last Updated**: October 2, 2025
**Related Documents**:
- Implementation: 11-20251002-002.03
- Testing: 12-20251002-002.04
- Future Phases: (Next)
