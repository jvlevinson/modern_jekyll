# Phase 7: Theme Editor - Testing & Quality Assurance Plan
**Document ID**: 12-20251002-002.04
**Created**: October 2, 2025
**Test Duration**: Week 3 (8 hours) + Ongoing
**Priority**: ðŸ”´ Critical - Quality assurance
**Dependencies**: Implementation complete (11-20251002-002.03)
**Type**: Comprehensive testing strategy

---

## Overview

This document outlines the complete testing strategy for the Theme Editor, covering unit tests, integration tests, accessibility validation, and manual QA procedures.

---

## Testing Philosophy

### Test Pyramid

```
    /\
   /E2\    E2E Tests (5% - Critical user flows)
  /____\
 /      \
/  Integ \  Integration Tests (25% - Component interactions)
----------
            Unit Tests (70% - Pure functions, utilities)
```

**Rationale**:
- **70% Unit Tests**: Fast, isolated, test business logic
- **25% Integration**: Test component interactions
- **5% E2E**: Test critical user workflows

---

## Testing Stack

### Tools & Libraries

```json
{
  "devDependencies": {
    "vitest": "^2.1.5",           // Fast unit test runner (Vite-powered)
    "jsdom": "^25.0.1",            // DOM environment for tests
    "@testing-library/dom": "^10.4.0",  // DOM testing utilities
    "@vitest/ui": "^2.1.5",        // Visual test UI
    "playwright": "^1.49.1",       // E2E testing
    "axe-core": "^4.10.2",         // Accessibility testing
    "@axe-core/playwright": "^4.10.0"  // Playwright + axe integration
  }
}
```

**Why Vitest?**
- âœ… 10-100x faster than Jest
- âœ… Native TypeScript support
- âœ… Compatible with esbuild
- âœ… Watch mode with HMR
- âœ… Browser-like environment (jsdom)

---

## Unit Testing Strategy

### What to Test

1. **Pure Functions** (100% coverage)
   - Color conversion utilities
   - Palette generation algorithm
   - Contrast calculation
   - Validation functions

2. **State Management** (90% coverage)
   - ConfigManager state transitions
   - EventBus pub/sub
   - Error handling

3. **Edge Cases** (Critical)
   - Invalid color values
   - Boundary conditions (0%, 100%, 360deg)
   - Null/undefined handling

### Test Structure

```typescript
// onboard/src/__tests__/utils/palette-generator.test.ts

import { describe, it, expect } from 'vitest';
import { generatePalette } from '../../utils/palette-generator';

describe('generatePalette', () => {
  describe('basic functionality', () => {
    it('should generate 10 shades from base color', () => {
      const base = { l: 60, c: 0.18, h: 262 };
      const palette = generatePalette(base);

      expect(Object.keys(palette)).toHaveLength(10);
      expect(palette).toHaveProperty('50');
      expect(palette).toHaveProperty('900');
    });

    it('should maintain hue across all shades', () => {
      const base = { l: 60, c: 0.18, h: 262 };
      const palette = generatePalette(base);

      Object.values(palette).forEach(color => {
        expect(color).toContain('262deg');
      });
    });
  });

  describe('lightness progression', () => {
    it('should have lightest shade at 50', () => {
      const base = { l: 60, c: 0.18, h: 262 };
      const palette = generatePalette(base);

      expect(palette['50']).toContain('95%'); // 95% lightness
    });

    it('should have darkest shade at 900', () => {
      const base = { l: 60, c: 0.18, h: 262 };
      const palette = generatePalette(base);

      // Base lightness 60%, darkest = 60 - 40 = 20%
      expect(palette['900']).toContain('20%');
    });
  });

  describe('chroma scaling', () => {
    it('should reduce chroma in light shades', () => {
      const base = { l: 60, c: 0.18, h: 262 };
      const palette = generatePalette(base);

      // Shade 50 should have 40% of base chroma
      const expectedChroma = (0.18 * 0.4).toFixed(3);
      expect(palette['50']).toContain(expectedChroma);
    });
  });

  describe('edge cases', () => {
    it('should handle zero chroma (grayscale)', () => {
      const base = { l: 50, c: 0, h: 0 };
      const palette = generatePalette(base);

      expect(palette['500']).toBe('oklch(50% 0 0deg)');
    });

    it('should handle maximum chroma (0.4)', () => {
      const base = { l: 60, c: 0.4, h: 180 };
      const palette = generatePalette(base);

      expect(palette['500']).toBe('oklch(60% 0.4 180deg)');
    });

    it('should handle hue wraparound (360deg)', () => {
      const base = { l: 60, c: 0.2, h: 359 };
      const palette = generatePalette(base);

      expect(palette['500']).toContain('359deg');
    });
  });
});
```

### Unit Test Files

```
onboard/src/__tests__/
â”œâ”€â”€ utils/
â”‚   â”œâ”€â”€ color-convert.test.ts         (50 tests)
â”‚   â”œâ”€â”€ palette-generator.test.ts     (30 tests)
â”‚   â”œâ”€â”€ contrast-checker.test.ts      (25 tests)
â”‚   â””â”€â”€ color-presets.test.ts         (15 tests)
â”œâ”€â”€ modules/
â”‚   â”œâ”€â”€ config-manager.test.ts        (40 tests)
â”‚   â”œâ”€â”€ event-bus.test.ts             (20 tests)
â”‚   â”œâ”€â”€ color-picker.test.ts          (35 tests)
â”‚   â””â”€â”€ theme-editor.test.ts          (30 tests)
â””â”€â”€ integration/
    â”œâ”€â”€ color-workflow.test.ts        (15 tests)
    â””â”€â”€ config-save.test.ts           (10 tests)
```

**Total**: ~270 unit/integration tests

---

## Integration Testing

### Test Scenarios

#### Scenario 1: Color Selection Workflow
```typescript
// onboard/src/__tests__/integration/color-workflow.test.ts

import { describe, it, expect, beforeEach } from 'vitest';
import { createColorPicker } from '../../modules/color-picker';
import { ConfigManager } from '../../modules/config-manager';
import { EventBus } from '../../modules/event-bus';

describe('Color Selection Workflow', () => {
  let container: HTMLElement;
  let configManager: ConfigManager;

  beforeEach(() => {
    // Setup DOM
    container = document.createElement('div');
    container.id = 'test-picker';
    document.body.appendChild(container);

    // Initialize config manager
    configManager = new ConfigManager();

    // Clear event listeners
    EventBus.clear();
  });

  it('should update config when color is selected', async () => {
    // Arrange
    const picker = createColorPicker({
      containerId: 'test-picker',
      label: 'Test Picker'
    });

    picker.render();

    // Act
    const colorInput = container.querySelector('input[type="color"]') as HTMLInputElement;
    colorInput.value = '#3b82f6';
    colorInput.dispatchEvent(new Event('input', { bubbles: true }));

    // Assert
    await new Promise(resolve => {
      EventBus.on('color:change', (payload) => {
        expect(payload.color).toBeDefined();
        expect(payload.color.h).toBeCloseTo(262, 1); // Blue hue
        resolve(true);
      });
    });
  });

  it('should generate palette after color selection', async () => {
    // Arrange
    const picker = createColorPicker({
      containerId: 'test-picker',
      label: 'Test Picker',
      showPalette: true
    });

    picker.render();

    // Act
    const colorInput = container.querySelector('input[type="color"]') as HTMLInputElement;
    colorInput.value = '#ef4444'; // Red
    colorInput.dispatchEvent(new Event('input', { bubbles: true }));

    // Assert
    const palette = picker.getPalette();
    expect(palette).toBeDefined();
    expect(Object.keys(palette!)).toHaveLength(10);
  });
});
```

#### Scenario 2: Config Save & Rebuild
```typescript
// onboard/src/__tests__/integration/config-save.test.ts

describe('Config Save & Rebuild', () => {
  it('should save config and trigger rebuild', async () => {
    // Arrange
    const configManager = new ConfigManager();
    await configManager.loadConfig();

    // Mock API
    global.fetch = vi.fn()
      .mockResolvedValueOnce({
        ok: true,
        json: async () => ({ success: true, message: 'Saved' })
      })
      .mockResolvedValueOnce({
        ok: true,
        json: async () => ({ buildId: 'test-123' })
      });

    // Act
    configManager.updateThemeProperty('brand_primary', {
      l: 70,
      c: 0.2,
      h: 30
    });

    await configManager.saveChanges();

    // Assert
    expect(fetch).toHaveBeenCalledWith(
      '/onboard/api/update-config',
      expect.objectContaining({
        method: 'POST'
      })
    );

    expect(configManager.hasPendingChanges()).toBe(false);
  });
});
```

---

## Accessibility Testing

### Automated Axe Tests

```typescript
// onboard/src/__tests__/accessibility/color-picker-a11y.test.ts

import { describe, it, expect } from 'vitest';
import { axe, toHaveNoViolations } from 'jest-axe';
import { createColorPicker } from '../../modules/color-picker';

expect.extend(toHaveNoViolations);

describe('Color Picker Accessibility', () => {
  it('should have no axe violations', async () => {
    // Arrange
    const container = document.createElement('div');
    container.id = 'test-picker';
    document.body.appendChild(container);

    const picker = createColorPicker({
      containerId: 'test-picker',
      label: 'Brand Color'
    });

    picker.render();

    // Act
    const results = await axe(container);

    // Assert
    expect(results).toHaveNoViolations();
  });

  it('should have accessible labels', () => {
    const container = document.createElement('div');
    container.id = 'test-picker';
    document.body.appendChild(container);

    const picker = createColorPicker({
      containerId: 'test-picker',
      label: 'Brand Color'
    });

    picker.render();

    const colorInput = container.querySelector('input[type="color"]');
    expect(colorInput).toHaveAttribute('aria-label');
  });

  it('should have keyboard navigation', () => {
    const container = document.createElement('div');
    container.id = 'test-picker';
    document.body.appendChild(container);

    const picker = createColorPicker({
      containerId: 'test-picker',
      label: 'Brand Color',
      showPresets: true
    });

    picker.render();

    // All interactive elements should be focusable
    const focusableElements = container.querySelectorAll('[tabindex], input, button');
    expect(focusableElements.length).toBeGreaterThan(0);

    focusableElements.forEach(el => {
      expect(el).not.toHaveAttribute('tabindex', '-1');
    });
  });
});
```

### Manual Accessibility Checklist

**WCAG 2.1 AA Compliance**:

- [ ] **Keyboard Navigation**
  - [ ] Tab through all interactive elements
  - [ ] Enter/Space activates buttons
  - [ ] Arrow keys navigate color swatches
  - [ ] Escape closes modals/dropdowns

- [ ] **Screen Reader**
  - [ ] All inputs have labels (aria-label or <label>)
  - [ ] Color changes announced (aria-live)
  - [ ] Error messages announced
  - [ ] Button purposes clear

- [ ] **Color Contrast**
  - [ ] Text: â‰¥ 4.5:1 contrast (normal text)
  - [ ] Text: â‰¥ 3:1 contrast (large text 18pt+)
  - [ ] UI elements: â‰¥ 3:1 contrast
  - [ ] Test with contrast checker tool

- [ ] **Focus Indicators**
  - [ ] Visible focus on all interactive elements
  - [ ] Focus indicator â‰¥ 2px width
  - [ ] Focus order logical (top â†’ bottom, left â†’ right)

- [ ] **Touch Targets**
  - [ ] All buttons â‰¥ 44Ã—44px
  - [ ] Adequate spacing between targets

---

## E2E Testing with Playwright

### Critical User Flows

```typescript
// e2e/theme-editor.spec.ts

import { test, expect } from '@playwright/test';
import { injectAxe, checkA11y } from 'axe-playwright';

test.describe('Theme Editor', () => {
  test.beforeEach(async ({ page }) => {
    await page.goto('http://localhost:4000/onboard/');
    await injectAxe(page);
  });

  test('User can select primary color and see preview update', async ({ page }) => {
    // Navigate to theme tab
    await page.click('text=Theme');

    // Open color picker
    const colorInput = page.locator('input[type="color"]').first();
    await colorInput.click();

    // Select color (blue)
    await colorInput.fill('#3b82f6');

    // Verify palette generated
    const palette = page.locator('.color-picker__palette');
    await expect(palette).toBeVisible();

    // Verify 10 shades displayed
    const shades = page.locator('.color-picker__shade');
    await expect(shades).toHaveCount(10);

    // Verify preview iframe updated
    const preview = page.frameLocator('#site-preview');
    // Check if brand color applied (this requires preview to load)
    await page.waitForTimeout(1000); // Wait for preview update
  });

  test('User can save theme and rebuild site', async ({ page }) => {
    // Select color
    await page.click('text=Theme');
    const colorInput = page.locator('input[type="color"]').first();
    await colorInput.fill('#ef4444'); // Red

    // Save button should be enabled
    const saveButton = page.locator('button:has-text("Save Changes")');
    await expect(saveButton).toBeEnabled();

    // Click save
    await saveButton.click();

    // Verify saving state
    await expect(saveButton).toHaveText('Saving...');

    // Wait for rebuild
    await page.waitForSelector('text=Rebuild complete', { timeout: 10000 });

    // Verify saved state
    await expect(saveButton).toHaveText('Save Changes');
    await expect(saveButton).toBeDisabled(); // No pending changes
  });

  test('Accessibility: No violations', async ({ page }) => {
    await page.click('text=Theme');
    await checkA11y(page);
  });

  test('Keyboard navigation works', async ({ page }) => {
    await page.click('text=Theme');

    // Tab through elements
    await page.keyboard.press('Tab');
    let focused = await page.evaluate(() => document.activeElement?.tagName);
    expect(['INPUT', 'BUTTON']).toContain(focused);

    // Navigate presets with arrow keys
    const firstPreset = page.locator('.color-picker__preset').first();
    await firstPreset.focus();
    await page.keyboard.press('ArrowRight');

    // Verify focus moved
    const secondPreset = page.locator('.color-picker__preset').nth(1);
    await expect(secondPreset).toBeFocused();
  });
});
```

### E2E Test Coverage

- [ ] **Color Selection**
  - [ ] Native color picker interaction
  - [ ] Preset color selection
  - [ ] Hex input
  - [ ] Palette generation

- [ ] **Theme Editing**
  - [ ] Primary color change
  - [ ] Secondary color change
  - [ ] Mode toggle (light/dark/auto)
  - [ ] Neutral palette selection

- [ ] **Save & Rebuild**
  - [ ] Config save API call
  - [ ] Rebuild trigger
  - [ ] Status polling
  - [ ] Success notification
  - [ ] Error handling

- [ ] **Preview**
  - [ ] Live updates
  - [ ] Iframe reload
  - [ ] Viewport switching

---

## Performance Testing

### Metrics to Track

```typescript
// Performance benchmarks

test('Palette generation performance', () => {
  const iterations = 1000;

  const start = performance.now();

  for (let i = 0; i < iterations; i++) {
    generatePalette({ l: 60, c: 0.18, h: 262 });
  }

  const end = performance.now();
  const avgTime = (end - start) / iterations;

  // Should be < 1ms per generation
  expect(avgTime).toBeLessThan(1);
});

test('Color conversion performance', () => {
  const iterations = 10000;

  const start = performance.now();

  for (let i = 0; i < iterations; i++) {
    hexToRgb('#3b82f6');
    rgbToOklch({ r: 59, g: 130, b: 246 });
  }

  const end = performance.now();
  const avgTime = (end - start) / iterations;

  // Should be < 0.1ms per conversion
  expect(avgTime).toBeLessThan(0.1);
});
```

### Lighthouse Targets

- **Performance**: â‰¥ 95/100
- **Accessibility**: â‰¥ 95/100
- **Best Practices**: 100/100
- **SEO**: (out of scope)

**Core Web Vitals**:
- FCP: < 1.0s
- LCP: < 1.5s
- TBT: < 100ms
- CLS: < 0.1

---

## Browser Compatibility Testing

### Target Browsers

| Browser | Version | Priority | Notes |
|---------|---------|----------|-------|
| Chrome | 111+ | High | OKLCH support |
| Safari | 15.4+ | High | OKLCH support |
| Firefox | 113+ | High | OKLCH support |
| Edge | 111+ | Medium | Chromium-based |
| Mobile Safari | iOS 15.4+ | High | Touch support |
| Mobile Chrome | Latest | High | Touch support |

### Compatibility Checklist

- [ ] **OKLCH Support**
  - [ ] Check `CSS.supports('color', 'oklch(50% 0.2 180deg)')`
  - [ ] Fallback to RGB if unsupported
  - [ ] Show warning message

- [ ] **ES2022 Features**
  - [ ] Optional chaining (`?.`)
  - [ ] Nullish coalescing (`??`)
  - [ ] Array.at()

- [ ] **Touch Events**
  - [ ] Color picker touch-enabled
  - [ ] Swipe gestures (if applicable)
  - [ ] Touch targets â‰¥ 44Ã—44px

---

## Test Data & Fixtures

### Color Test Data

```typescript
// onboard/src/__tests__/fixtures/colors.ts

export const TEST_COLORS = {
  // Primary colors
  red: { l: 55, c: 0.22, h: 25 },
  orange: { l: 70, c: 0.18, h: 60 },
  yellow: { l: 85, c: 0.15, h: 90 },
  green: { l: 60, c: 0.18, h: 145 },
  blue: { l: 60, c: 0.18, h: 262 },
  purple: { l: 60, c: 0.21, h: 310 },

  // Edge cases
  black: { l: 0, c: 0, h: 0 },
  white: { l: 100, c: 0, h: 0 },
  gray: { l: 50, c: 0, h: 0 },

  // Boundary values
  maxChroma: { l: 60, c: 0.4, h: 180 },
  minChroma: { l: 60, c: 0, h: 180 },
  maxLightness: { l: 100, c: 0.2, h: 180 },
  minLightness: { l: 0, c: 0.2, h: 180 },
  maxHue: { l: 60, c: 0.2, h: 359 },
  minHue: { l: 60, c: 0.2, h: 0 }
};

export const EXPECTED_PALETTES = {
  blue: {
    50: 'oklch(95% 0.072 262deg)',
    100: 'oklch(90% 0.09 262deg)',
    // ... all 10 shades
    900: 'oklch(20% 0.108 262deg)'
  }
};
```

### Config Test Data

```typescript
// onboard/src/__tests__/fixtures/configs.ts

export const TEST_CONFIGS = {
  default: {
    theme: {
      brand_primary: { l: 60, c: 0.18, h: 262 },
      brand_secondary: null,
      neutral: 'slate' as const,
      mode: 'light' as const
    }
  },

  withSecondary: {
    theme: {
      brand_primary: { l: 60, c: 0.18, h: 262 },
      brand_secondary: { l: 60, c: 0.18, h: 145 },
      neutral: 'gray' as const,
      mode: 'dark' as const
    }
  }
};
```

---

## Test Execution Plan

### Week 3: Testing Sprint

**Day 1: Unit Tests (3 hours)**
- Write utility tests (color-convert, palette-generator)
- Write validation tests
- Run coverage report (target: 90%+)

**Day 2: Integration Tests (2 hours)**
- Color selection workflow
- Config save workflow
- Event bus integration

**Day 3: E2E Tests (2 hours)**
- Playwright setup
- Critical user flows
- Accessibility checks

**Day 4: Manual QA (1 hour)**
- Browser compatibility
- Touch device testing
- Screen reader testing

### CI/CD Integration

```yaml
# .github/workflows/test.yml
name: Test

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install

      - name: Type check
        run: npm run type-check

      - name: Run unit tests
        run: npm test

      - name: Run E2E tests
        run: npx playwright test

      - name: Upload coverage
        uses: codecov/codecov-action@v4
```

---

## Success Criteria

### Test Coverage
- [ ] **Unit Tests**: â‰¥ 90% coverage
- [ ] **Integration Tests**: All critical workflows covered
- [ ] **E2E Tests**: All user flows automated
- [ ] **Accessibility**: Zero axe violations

### Performance
- [ ] Palette generation: < 1ms
- [ ] Color conversion: < 0.1ms
- [ ] Lighthouse: â‰¥ 95/100

### Quality
- [ ] All tests passing
- [ ] No TypeScript errors
- [ ] No console errors/warnings
- [ ] Accessibility WCAG 2.1 AA compliant

---

## Ongoing Testing

### Regression Testing
- Run full test suite before each PR merge
- Automated via GitHub Actions
- Block merge if tests fail

### Manual Testing Cadence
- **Weekly**: Browser compatibility spot-check
- **Monthly**: Full accessibility audit
- **Quarterly**: Lighthouse performance review

---

**Document Status**: âœ… Complete
**Last Updated**: October 2, 2025
**Related Documents**:
- Implementation: 11-20251002-002.03-phase-7-implementation.md
- Integration Plan: (Next)
